<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Race Results</title>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #121318;
      --muted: #9aa3b2;
      --text: #eef2f7;
      --accent: #4f8cff;
      --ring: rgba(79,140,255,.35);
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, #0f1320, var(--bg));
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(11,12,16,.9), rgba(11,12,16,.6));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap { max-width: 900px; margin: 0 auto; padding: 20px; }
    h1 { margin: 6px 0 2px; font-weight: 700; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 13px; }

    .toolbar { display: grid; gap: 10px; grid-template-columns: 1fr auto auto; padding: 12px 0 6px; }
    .search {
      display: flex; align-items: center; gap: 8px;
      background: #0f1016; border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px; padding: 10px 12px;
    }
    .search input { flex: 1; background: transparent; border: 0; color: var(--text); outline: none; }
    .select { appearance: none; background: #0f1016; color: var(--text); border: 1px solid rgba(255,255,255,.08); padding: 10px 12px; border-radius: 12px; }

    .year { margin: 24px 0 8px; font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: .6px; }

    ul.results { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
    li.card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 14px;
      display: grid; gap: 6px;
    }
    .row { display: flex; flex-wrap: wrap; gap: 10px 14px; align-items: center; }
    .name { font-weight: 650; font-size: 16px; }
    .meta { color: var(--muted); font-size: 13px; }

    .badge { font-size: 11px; line-height: 1; padding: 6px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); }
    .badge.pr { border-color: var(--ok); color: #d7fde6; background: rgba(34,197,94,.08); }
    .badge.warm { border-color: var(--warn); color: #fff7e5; background: rgba(245,158,11,.08); }

    .grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px 14px; }
    .kv { background: #0f1016; border: 1px solid rgba(255,255,255,.06); border-radius: 10px; padding: 8px 10px; }
    .kv .k { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
    .kv .v { font-weight: 600; }

    details { margin-top: 4px; }
    details summary { cursor: pointer; color: var(--accent); }

    footer { color: var(--muted); font-size: 12px; text-align: center; padding: 28px 0 36px; }

    /* focus styles */
    :focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; border-radius: 8px; }

    @media (min-width: 720px) {
      .grid { grid-template-columns: repeat(4, minmax(0,1fr)); }
      li.card { padding: 16px 18px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Race Results</h1>
      <div class="sub" id="summary">Personal race log</div>
      <div class="toolbar" role="region" aria-label="Filters">
        <div class="search" aria-label="Search by race name or city">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="q" type="search" placeholder="Search races…" autocomplete="off" />
        </div>
        <select id="year" class="select" aria-label="Filter by year"></select>
        <select id="dist" class="select" aria-label="Filter by distance"></select>
      </div>
    </div>
  </header>
  <main class="wrap" id="app" aria-live="polite">
    <p id="loading">Loading results…</p>
  </main>
  <footer>
    Built from <code>races.json</code>. Type to search · Filter by year or distance · Sorted newest first
  </footer>

  <script>
    // ---- Utilities ----
    const KM_PER_MI = 1.609344;
    const el = sel => document.querySelector(sel);
    const fmtDate = iso => new Date(iso + 'T00:00:00').toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
    const yearOf = iso => new Date(iso + 'T00:00:00').getFullYear();
    const parseHMS = (s) => { // "HH:MM:SS" -> seconds
      if (!s) return null;
      const [hh='0',mm='0',ss='0'] = s.split(':');
      return (+hh)*3600 + (+mm)*60 + (+ss);
    };
    const fmtPace = (secPerMi) => {
      if (secPerMi == null || !isFinite(secPerMi)) return '—';
      const m = Math.floor(secPerMi/60), s = Math.round(secPerMi%60).toString().padStart(2,'0');
      return `${m}:${s}/mi`;
    };
    const round = (n, d=2) => Number.parseFloat(n).toFixed(d);

    const uniqueSorted = arr => [...new Set(arr)].sort((a,b)=>a>b?1:-1);

    // ---- Rendering ----
    function render(results) {
      const app = el('#app');
      app.innerHTML = '';

      // Group by year, newest first
      const byYear = new Map();
      for (const r of results) {
        const y = yearOf(r.date);
        if (!byYear.has(y)) byYear.set(y, []);
        byYear.get(y).push(r);
      }
      const years = [...byYear.keys()].sort((a,b)=>b-a);

      let total = 0;
      for (const y of years) {
        const list = byYear.get(y).sort((a,b)=> new Date(b.date) - new Date(a.date));
        total += list.length;

        const yEl = document.createElement('div');
        yEl.innerHTML = `<div class="year" aria-label="${y} group">${y}</div><ul class="results" id="y-${y}"></ul>`;
        app.appendChild(yEl);
        const ul = yEl.querySelector('ul');

        for (const r of list) ul.appendChild(card(r));
      }

      el('#summary').textContent = `${total} races • newest first`;
    }

    function card(r) {
      const li = document.createElement('li');
      li.className = 'card';

      // Compute pace (per mile) from distance_km + time
      const secs = parseHMS(r.chip_time || r.time);
      const distKm = r.distance_km ?? null;
      const distMi = distKm ? (distKm / KM_PER_MI) : (r.distance_mi ?? null);
      const paceSecPerMi = (secs && distMi) ? secs / distMi : null;

      // Badges
      const badges = [];
      if (r.is_pr) badges.push('<span class="badge pr" title="Personal Record">PR</span>');
      if (r.weather && /hot|warm|humid/i.test(r.weather)) badges.push('<span class="badge warm">Warm</span>');

      li.innerHTML = `
        <div class="row">
          <div class="name">${escapeHtml(r.name || 'Untitled Race')}</div>
          <div class="meta">${fmtDate(r.date)}${r.city ? ' • ' + escapeHtml(r.city) : ''}</div>
          ${badges.join('')}
        </div>
        <div class="grid" role="group" aria-label="Key metrics">
          ${kv('Distance', distMi ? `${round(distMi,2)} mi` : (distKm? `${round(distKm,2)} km` : '—'))}
          ${kv('Time', secs ? (r.chip_time || r.time) : '—')}
          ${kv('Pace', fmtPace(paceSecPerMi))}
          ${kv('Category', r.category || '—')}
        </div>
        ${r.notes || r.splits || r.terrain || r.weather ? details(r) : ''}
      `;
      return li;
    }

    function kv(k, v) {
      return `<div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>`;
    }

    function details(r) {
      const rows = [];
      if (r.splits) rows.push(`<div><strong>Splits:</strong> ${Object.entries(r.splits).map(([k,v])=>`${k} ${v}`).join(', ')}</div>`);
      if (r.terrain) rows.push(`<div><strong>Terrain:</strong> ${escapeHtml(r.terrain)}</div>`);
      if (r.weather) rows.push(`<div><strong>Weather:</strong> ${escapeHtml(r.weather)}</div>`);
      if (r.notes) rows.push(`<div><strong>Notes:</strong> ${escapeHtml(r.notes)}</div>`);
      return `<details><summary>Details</summary>${rows.join('')}</details>`;
    }

    function populateFilters(data) {
      const years = uniqueSorted(data.map(r => String(yearOf(r.date)))).reverse();
      const dists = uniqueSorted(data.map(r => r.distance_km ? distLabel(r.distance_km) : (r.distance_mi? distLabelMi(r.distance_mi) : 'Unknown')));
      const yearSel = el('#year');
      const distSel = el('#dist');
      yearSel.innerHTML = '<option value="">All years</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
      distSel.innerHTML = '<option value="">All distances</option>' + dists.map(d=>`<option value="${d}">${d}</option>`).join('');
    }

    function distLabel(km) {
      const common = { 5: '5K', 10: '10K', 21.0975: 'Half', 42.195: 'Marathon', 1.609: '1 Mile', 11.265: '7 Mile' };
      const keys = Object.keys(common).map(parseFloat);
      const near = keys.find(x => Math.abs(x - km) < 0.05);
      return near ? common[near] : `${round(km,2)} km`;
    }
    function distLabelMi(mi) {
      const common = { 3.107: '5K', 6.214: '10K', 13.109: 'Half', 26.219: 'Marathon', 7: '7 Mile', 1: '1 Mile' };
      const keys = Object.keys(common).map(parseFloat);
      const near = keys.find(x => Math.abs(x - mi) < 0.05);
      return near ? common[near] : `${round(mi,2)} mi`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"]g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    // ---- Filtering ----
    function applyFilters() {
      const q = el('#q').value.trim().toLowerCase();
      const y = el('#year').value;
      const d = el('#dist').value;
      const filtered = window.__data.filter(r => {
        const matchesQ = !q || `${r.name} ${r.city}`.toLowerCase().includes(q);
        const matchesY = !y || String(yearOf(r.date)) === y;
        const dist = r.distance_km ? distLabel(r.distance_km) : (r.distance_mi ? distLabelMi(r.distance_mi) : 'Unknown');
        const matchesD = !d || dist === d;
        return matchesQ && matchesY && matchesD;
      }).sort((a,b)=> new Date(b.date) - new Date(a.date));
      render(filtered);
    }

    // ---- Bootstrap ----
    (async function init(){
      try {
        const res = await fetch('races.json', { cache: 'no-store' });
        const data = await res.json();
        window.__data = data;
        populateFilters(data);
        render(data.sort((a,b)=> new Date(b.date) - new Date(a.date)));
        el('#loading')?.remove();
        ['#q','#year','#dist'].forEach(sel=> el(sel).addEventListener('input', applyFilters));
      } catch (err) {
        el('#loading').textContent = 'Failed to load races.json';
        console.error(err);
      }
    })();
  </script>
</body>
</html>
